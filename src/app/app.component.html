<div class="container">
  <div class="header-section">
    <div class="header">{{ titolo }}</div>
    <button
      pButton
      label="Inserire nuova agenzia"
      icon="pi pi-plus"
      severity="primary"
      class="insert-button"
      (click)="apriDialogInserisci()"
    ></button>
    <button
      pButton
      label="Consultar números primos"
      icon="pi pi-search"
      class="consult-primes-button p-button-outlined"
      (click)="apriDialogPrimi()"
    ></button>
  </div>

  <p-table
    [value]="agenzieFiltrate"
    [tableStyle]="{
      'min-width': '64rem',
      background: isDarkMode ? '#1a1f2e' : '#ffffff'
    }"
    [paginator]="true"
    [rows]="8"
    [sortMode]="'multiple'"
    styleClass="custom-table"
    [style]="{ background: isDarkMode ? '#1a1f2e' : '#ffffff' }"
  >
    <ng-template pTemplate="caption">
      <div class="filters">
        <div class="filter-group">
          <label class="filter-label">Codice</label>
          <input
            pInputText
            type="text"
            placeholder="Filtra Codice"
            [(ngModel)]="filtroCodice"
          />
        </div>

        <div class="filter-group">
          <label class="filter-label">Denominazione</label>
          <input
            pInputText
            type="text"
            placeholder="Filtra Denominazione"
            [(ngModel)]="filtroDenominazione"
          />
        </div>

        <div class="filter-group">
          <label class="filter-label">Data Nomina</label>
          <p-datepicker
            [(ngModel)]="filtroData"
            placeholder="Seleziona data"
            [showIcon]="true"
            iconDisplay="input"
            dateFormat="dd/mm/yy"
            [showClear]="true"
            [showButtonBar]="true"
          ></p-datepicker>
        </div>

        <div class="filter-group">
          <label class="filter-label">Stato</label>
          <p-select
            [options]="stati"
            [(ngModel)]="filtroStato"
            placeholder="Tutti"
            optionLabel="label"
            optionValue="value"
          ></p-select>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="codice">Codice <p-sortIcon field="codice" /></th>
        <th pSortableColumn="denominazione">
          Denominazione <p-sortIcon field="denominazione" />
        </th>
        <th pSortableColumn="dataNomina">
          Data Nomina <p-sortIcon field="dataNomina" />
        </th>
        <th pSortableColumn="stato">Stato <p-sortIcon field="stato" /></th>
        <th style="width: 10rem">Azioni</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-a>
      <tr>
        <td>{{ a.codice }}</td>
        <td>{{ a.denominazione }}</td>
        <td>{{ a.dataNomina | date : "dd/MM/yyyy" }}</td>
        <td>
          <p-tag [severity]="statoSeverita(a.stato)">
            <i [class]="statoIcon(a.stato)"></i>
            {{ a.stato }}
          </p-tag>
        </td>
        <td class="azioni">
          <button
            pButton
            pTooltip="Dettagli"
            icon="pi pi-user"
            class="p-button-rounded p-button-text"
            (click)="apriDialog(a)"
          ></button>
          <button
            pButton
            pTooltip="Modifica"
            icon="pi pi-pencil"
            class="p-button-rounded p-button-text"
            (click)="apriDialogModifica(a)"
          ></button>
          <button
            pButton
            pTooltip="Vai"
            icon="pi pi-arrow-right"
            class="p-button-rounded p-button-text"
          ></button>
          <button
            pButton
            pTooltip="Elimina"
            icon="pi pi-trash"
            class="p-button-rounded p-button-text p-button-danger"
            (click)="elimina(a)"
          ></button>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Dialog per consultare numeri primi -->
  <p-dialog
    [(visible)]="dialogPrimiVisibile"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '36rem' }"
    header="Consultar números primos"
  >
    <div class="primes-dialog">
      <div class="form-group">
        <label class="form-label">Número a verificar</label>
        <input
          pInputText
          type="number"
          [(ngModel)]="numeroDaVerificar"
          class="form-input"
        />
      </div>

      <div style="display: flex; gap: 0.75rem; margin-top: 0.5rem">
        <button
          pButton
          label="Comprobar"
          (click)="controllaPrimo()"
          class="p-button-sm p-button-primary"
        ></button>
        <button
          pButton
          label="Mostrar primos hasta 1000"
          (click)="mostraTuttiPrimi()"
          class="p-button-sm p-button-secondary"
        ></button>
      </div>

      <div
        *ngIf="esitoPrimo !== null"
        style="margin-top: 1rem; font-weight: 600"
      >
        {{ esitoPrimo }}
      </div>

      <div
        *ngIf="primiFino1000?.length"
        style="margin-top: 1rem; max-height: 200px; overflow: auto"
      >
        <h4>Primos (2..1000)</h4>
        <div *ngFor="let row of primiFino1000Rows">
          <div>{{ row.join(" ") }}</div>
        </div>
      </div>
    </div>
  </p-dialog>

  <p-dialog
    [(visible)]="dialogVisibile"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '32rem' }"
    header="Dettaglio Agenzia"
  >
    <ng-container *ngIf="selezionata as s">
      <div class="dlg-row">
        <span class="lbl">Codice:</span> <span>{{ s.codice }}</span>
      </div>
      <div class="dlg-row">
        <span class="lbl">Denominazione:</span>
        <span>{{ s.denominazione }}</span>
      </div>
      <div class="dlg-row">
        <span class="lbl">Data Nomina:</span>
        <span>{{ s.dataNomina | date : "dd/MM/yyyy" }}</span>
      </div>
      <div class="dlg-row">
        <span class="lbl">Stato:</span>
        <p-tag [severity]="statoSeverita(s.stato)">
          <i [class]="statoIcon(s.stato)"></i>
          {{ s.stato }}
        </p-tag>
      </div>
    </ng-container>
    <ng-template pTemplate="footer">
      <button
        pButton
        label="Chiudi"
        icon="pi pi-times"
        (click)="chiudiDialog()"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog di Modifica -->
  <p-dialog
    [(visible)]="dialogModificaVisibile"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '40rem' }"
    header="Modifica Agenzia"
  >
    <ng-container *ngIf="agenziaInModifica as a">
      <div class="form-container">
        <div class="form-group">
          <label class="form-label">Codice:</label>
          <input
            pInputText
            type="number"
            [(ngModel)]="a.codice"
            class="form-input"
            [class.input-error]="erroreCodiceModifica"
            (ngModelChange)="validaCodiceModifica()"
          />
          <div *ngIf="erroreCodiceModifica" class="error-message">
            <i class="pi pi-exclamation-triangle"></i>
            {{ messaggioErroreModifica }}
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Denominazione:</label>
          <input
            pInputText
            type="text"
            [(ngModel)]="a.denominazione"
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Data Nomina:</label>
          <input
            pInputText
            type="date"
            [(ngModel)]="a.dataNomina"
            class="form-input"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Stato:</label>
          <p-select
            [options]="statiInserimento"
            [(ngModel)]="a.stato"
            class="form-input"
            placeholder="Seleziona stato"
            [appendTo]="'body'"
            [showClear]="false"
            optionLabel="label"
            optionValue="value"
            [filter]="false"
          ></p-select>
        </div>
      </div>
    </ng-container>

    <ng-template pTemplate="footer">
      <button
        pButton
        label="Annulla"
        icon="pi pi-times"
        severity="secondary"
        (click)="annullaModifica()"
      ></button>
      <button
        pButton
        label="Salva"
        icon="pi pi-check"
        severity="primary"
        (click)="salvaModifica()"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Dialog per Inserire Nuova Agenzia -->
  <p-dialog
    [(visible)]="dialogInserisciVisibile"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '40rem' }"
    header="Inserisci Nuova Agenzia"
  >
    <div class="form-container">
      <div class="form-group">
        <label class="form-label">Codice (Assegnato automaticamente):</label>
        <input
          pInputText
          type="number"
          [(ngModel)]="nuovaAgenzia.codice"
          class="form-input auto-generated-field"
          [readonly]="true"
          placeholder="Generato automaticamente"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Denominazione:</label>
        <input
          pInputText
          type="text"
          [(ngModel)]="nuovaAgenzia.denominazione"
          class="form-input"
          placeholder="Inserisci denominazione"
        />
      </div>

      <div class="form-group">
        <label class="form-label">Data Nomina:</label>
        <span class="p-input-icon-right">
          <i class="pi pi-calendar"></i>
          <p-datepicker
            [(ngModel)]="nuovaAgenzia.dataNomina"
            placeholder="Seleziona data"
            dateFormat="dd/mm/yy"
            [showClear]="true"
            [showButtonBar]="true"
            [appendTo]="'body'"
            class="form-input"
          ></p-datepicker>
        </span>
      </div>

      <div class="form-group">
        <label class="form-label">Stato:</label>
        <p-select
          [options]="statiInserimento"
          [(ngModel)]="nuovaAgenzia.stato"
          class="form-input"
          placeholder="Seleziona stato"
          optionLabel="label"
          optionValue="value"
          [appendTo]="'body'"
        ></p-select>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button
        pButton
        label="Annulla"
        icon="pi pi-times"
        severity="secondary"
        (click)="annullaInserimento()"
      ></button>
      <button
        pButton
        label="Salva"
        icon="pi pi-check"
        severity="primary"
        (click)="salvaInserimento()"
      ></button>
    </ng-template>
  </p-dialog>

  <!-- Botón flotante para dark mode (abajo a la derecha) -->
  <button
    pButton
    [icon]="isDarkMode ? 'pi pi-sun' : 'pi pi-moon'"
    class="dark-mode-toggle"
    [pTooltip]="isDarkMode ? 'Modo claro' : 'Modo oscuro'"
    tooltipPosition="left"
    (click)="toggleDarkMode()"
  ></button>
</div>
